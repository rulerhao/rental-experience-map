<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¬è©¦åœ°å€æ¬„ä½</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="src/client/css/rental-form.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        #map {
            height: 400px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .info-box {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ  æ¸¬è©¦åœ°å€æ¬„ä½åŠŸèƒ½</h1>
        <p>é€™å€‹é é¢ç”¨ä¾†æ¸¬è©¦æ–°å¢çš„ã€Œåœ°å€ã€æ¬„ä½åŠŸèƒ½ã€‚</p>
        
        <div class="info-box">
            <h3>æ¸¬è©¦èªªæ˜ï¼š</h3>
            <ul>
                <li>é»æ“Šã€Œé–‹å•Ÿç§Ÿå±‹è¡¨å–®ã€æŒ‰éˆ•</li>
                <li>åœ¨åœ°åœ–ä¸Šé¸æ“‡ä¸€å€‹ä½ç½®</li>
                <li>åœ¨åŸºæœ¬è³‡è¨Šå€å¡Šä¸­ï¼Œä½ æœƒçœ‹åˆ°æ–°çš„ã€Œåœ°å€ã€æ¬„ä½</li>
                <li>é€™å€‹æ¬„ä½å¯ä»¥è®“ä½ è¼¸å…¥è©³ç´°çš„åœ°å€æè¿°</li>
                <li>å¡«å¯«å®Œæ•´è¡¨å–®ä¸¦æäº¤æ¸¬è©¦</li>
            </ul>
        </div>

        <button class="test-button" onclick="openRentalForm()">é–‹å•Ÿç§Ÿå±‹è¡¨å–®</button>
        <button class="test-button" onclick="loadRentals()">è¼‰å…¥ç¾æœ‰è³‡æ–™</button>
        
        <div id="map"></div>
        
        <div id="rentalsList"></div>
    </div>

    <!-- è¼‰å…¥å¿…è¦çš„è…³æœ¬ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="src/client/js/I18nService.js"></script>
    <script src="src/client/js/ApiService.js"></script>
    <script src="src/client/js/MapManager.js"></script>
    <script src="src/client/js/RentalFormManager.js"></script>

    <script>
        // åˆå§‹åŒ–æœå‹™
        const i18n = new I18nService();
        const apiService = new ApiService();
        let mapManager;
        let rentalFormManager;

        // åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            const map = L.map('map').setView([25.0330, 121.5654], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            mapManager = new MapManager(map, apiService);
            rentalFormManager = new RentalFormManager(apiService, mapManager, i18n);
            
            // è¨­ç½®æˆåŠŸå›èª¿
            rentalFormManager.setOnSuccess((location) => {
                console.log('ç§Ÿå±‹ç¶“é©—æ–°å¢æˆåŠŸï¼', location);
                loadRentals(); // é‡æ–°è¼‰å…¥è³‡æ–™
            });
        }

        // é–‹å•Ÿç§Ÿå±‹è¡¨å–®
        function openRentalForm() {
            rentalFormManager.show();
        }

        // è¼‰å…¥ç§Ÿå±‹è³‡æ–™
        async function loadRentals() {
            try {
                const response = await fetch('/api/rentals');
                const rentals = await response.json();
                
                const listDiv = document.getElementById('rentalsList');
                listDiv.innerHTML = '<h3>ç¾æœ‰ç§Ÿå±‹è³‡æ–™ï¼š</h3>';
                
                if (rentals.length === 0) {
                    listDiv.innerHTML += '<p>ç›®å‰æ²’æœ‰è³‡æ–™</p>';
                    return;
                }
                
                rentals.forEach(rental => {
                    const rentalDiv = document.createElement('div');
                    rentalDiv.className = 'info-box';
                    rentalDiv.innerHTML = `
                        <h4>ID: ${rental.id}</h4>
                        <p><strong>åœ°åœ–åœ°å€ï¼š</strong> ${rental.address}</p>
                        ${rental.descriptive_address ? `<p><strong>è©³ç´°åœ°å€ï¼š</strong> ${rental.descriptive_address}</p>` : ''}
                        <p><strong>æè¿°ï¼š</strong> ${rental.description}</p>
                        <p><strong>åº§æ¨™ï¼š</strong> ${rental.lat}, ${rental.lng}</p>
                        <p><strong>å»ºç«‹æ™‚é–“ï¼š</strong> ${rental.created_at}</p>
                    `;
                    listDiv.appendChild(rentalDiv);
                });
                
            } catch (error) {
                console.error('è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                document.getElementById('rentalsList').innerHTML = '<p style="color: red;">è¼‰å…¥è³‡æ–™å¤±æ•—</p>';
            }
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            await i18n.init();
            initMap();
            loadRentals();
        });
    </script>
</body>
</html>